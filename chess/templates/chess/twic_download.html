<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TWIC Status</title>
    <meta name="csrf-token" content="{{ csrf_token }}">
    <script>
        function handleDownload() {
            const lastDownload = parseInt(document.querySelector("#lastDownload").textContent, 10);
            const available = parseInt({{ available_number }}, 10);

            if (isNaN(lastDownload) || isNaN(available)) {
                alert("Invalid download or available number.");
                return;
            }

            fetch("{% url 'download_twic' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    last_download_number: lastDownload,
                    available_number: available
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    alert(data.message);

                    // Update the displayed last_download_number dynamically
                    document.querySelector("#lastDownload").textContent = data.updated_last_download_number;
                    document.querySelector("#downloadButton").disabled = true;
                } else {
                    alert(data.message);
                }
            })
            .catch(error => console.error("Error:", error));
        }
    
        function handleCancel() {
            // Perform the cancel action by redirecting to the main page
            window.location.href = "{% url 'main_page' %}";
        }

    </script>
</head>
<body>
    <h1>TWIC Status</h1>
    <p>Latest Download: <span id="lastDownload">{{ last_download_number }}</span></p>
    <p>Available: {{ available_number }}</p>

    <button onclick="handleDownload()" {% if not can_download_new %}disabled{% endif %}>Download</button>
    <button onclick="handleCancel()">Cancel</button>
</body>
</html>
